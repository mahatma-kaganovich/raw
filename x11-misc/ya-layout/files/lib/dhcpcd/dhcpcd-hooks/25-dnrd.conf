# dnrd dns cache

# add "nameserver <ip>" first into /etc/resolv.conf.head
# where ip one of:

# not kill on if_down
bind1=127.0.0.242
# strict: fix on every change
bind2=127.0.0.42

_dnrd(){
	local p c= s= x y
	p=$(< /run/dnrd.pid) && c="$(sed -e 's:\x0: :g' </proc/$p/cmdline)"
	while read x y; do
		case "$x" in
		nameserver)[ "$y" = $bind1 -o "$y" = $bind2 ] && s+=" -a $y" || s+=" -s $y";;
		esac
	done </etc/resolv.conf
	[ "dnrd$s " = "$c" ] && return
	[[ "$s" == " -a $bind1 "* ]] && ${if_down:-false} && return
	[[ "$c" == 'dnrd '* ]] && killall -w dnrd
	[[ "$s" == ' -a '*' -s '* ]] && dnrd$s
}

_dnrd
