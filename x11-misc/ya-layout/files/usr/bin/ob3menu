#!/usr/bin/perl
# (c) Denis Kaganovich, Anarchy or GPLv2
# OpenBox3 pipe menu v0.2
# ob3menu {--<command> {param}}
# 	--slow {<path/to/rc.xml>}
#	--autostart {profile}
# "--slow" - +keybinds, 3.5.0+ menu icons, better with cache.

for(@ARGV){
	if($_=~s/^--//){
		undef $P{$i=$_};
	}else{
		push(@{$P{$i}},$_);
	}
}

for($ENV{LANG}=~/([a-zA-Z0-9]+)?(_\w+)?(\.[\w-]+)?(\@\w+)?/){
	$lang.='(?:'.quotemeta($_).')?' if(defined($_));
}
$lang='(?:\['.$lang.'\])?' if($lang);

@path=split(/:/,$ENV{PATH});

sub eXist{
	if(index($_[0],'/')>=0){
		stat($_[0]);
		return(-x _ && -f _);
	}
	for(@path){
		stat("$_/$_[0]");
		return 1 if(-x _ && -f _);
	}
	0;
}

my (%ico,%key,%cat,%cat,%cc);

if(exists($P{slow})){
	for(@{$P{slow}}){
		my $s;
		open($F,"<$_") && read($F,$s,-s $F);
		close($F);
		$P{'slow'}=index($s,'<showIcons>yes</showIcons>')>=0;
		$s=~s/<keybind\s+key=\"(.*?)\".*?>\s*<action name=\"Execute\">.*?<command>(.*?)<\/command>/$key{$2}=$1;''/gse;
	};
	open($F,'find /usr/share/icons|');
	while(<$F>){
		chomp($_);
		next if($_=~/\.svg$/);
		$i=$_;
		~s/.*\///;
		$ico{$_}=$i;
		$ico{$_}=$i if (~s/\....$//);
	}
	close($F);
	while(</usr/share/pixmaps/*.???>){
		chomp($_);
		next if($_=~/\.svg$/);
		$i=$_;
		~s/.*\///;
		$ico{$_}=$i;
		~s/\....$//;
		$ico{$_}=$i;
	}
}

for $f(</usr/share/applications/*.desktop>,</usr/share/applications/*/*.desktop>,</usr/share/ya-layout/Desktop/*.desktop>,</usr/share/ya-layout/Desktop/exit/*.desktop>,</etc/xdg/autostart/*.desktop>){
	my %d;
	open(my $F,"<$f")||next;
	while(<$F>){
		$d{$k}=$v if(($k,$v)=$_=~/^\s*([^#\s=\[\]#]+)$lang\s*=([^#\n\r]*)/i);
	}
	close($F);
	next if((exists($d{TryExec}) && !eXist($d{TryExec})) || !exists($d{Exec}));
	$d{Exec}="/usr/bin/ya-session --run +$d{Exec}" if($d{Terminal} && lc($d{Terminal}) ne 'false');
	if(!exists($d{Name})){
#		print STDERR "Name? $f\n";
		for $i ('Comment','Exec'){
			if(exists($d{$i})){
				$d{Name}=$d{$i};
				goto N;
			}
		}
		next;
	}
N:
	$i='';
	if(exists($P{slow}) && exists($d{Icon})){
		$i=$d{Icon};
		$i=~s/(?:.*\/)?(.*?).svg$/$1.png/;
		$i=$ico{$i} if(exists($ico{$i}));
		$i=" icon=\"$i\"";
	}
	if($d{Type} eq 'Application'){
		next if(!exists($d{Exec}));
		$d{Exec}=~s/\s+%\w$//;
		$d{Name}.=" 	[$key{$d{Exec}}]" if(exists($key{$d{Exec}}));
		$i="<item label=\"$d{Name}\"$i><action name=\"Execute\"><execute>$d{Exec}</execute></action></item>";
	}else{
#		print STDERR "Type=$d{Type}? $f\n";
		next;
	}
	if(substr($f,0,4) eq '/etc'){
		$d{Categories}='Autostart';
		if(exists($P{autostart})){
			my $i=join('|',@{$P{autostart}})||$ENV{YA_PROFILE}||'--';
			print STDERR "$d{Exec} &\n" if(!exists($d{OnlyShowIn}) || grep(/^(?:$i)$/i,split(';',$d{OnlyShowIn})));
		}
	}
	for(split(/;/,$d{Categories})){
		next if($_ eq '' || exists($cat{$i}->{$_}));
		$cat{$i}->{$_}=1;
		$cc{$_}++;
	}
	$cat{$i}=undef if(!exists($cat{$i}));
}
$_=defined($_)?[sort{$cc{$a} <=> $cc{$b}}(keys %{$_})]:['misc'] for(values %cat);
push @{$cat1{pop @{$cat{$_}}}},$_ for(keys %cat);
for(keys %cat){
	for $i (@{delete($cat{$_})}){
		push @{$cat1{$i}},$_ if(exists($cat1{$i}))
	}
}
$i=0;
print "<openbox_pipe_menu>";
for(sort keys %cat1){
	$i++;
	print "<menu id=\"$i\" label=\"$_\">".join('',sort @{$cat1{$_}})."</menu>";
}
print "</openbox_pipe_menu>";
