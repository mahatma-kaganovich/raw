#!/bin/bash
# pipe menu cache for OpenBox3 v0.6
# icons changes not tracked
# param: generator command:

ob3menu-cache(){
local cmd="${*:-/usr/bin/ob3menu --slow}"
#local cmd="${*:-/usr/bin/mmaker -ci OpenBox3}"
. "$HOME/.cache/ya/environment" && cmd=${cmd/ob3menu --slow/ob3menu --autostart $YA_XDG_AUTOSTART --profile $YA_PROFILE --slow}
local m="$HOME/.cache/ya/menu.xml" c="/usr/share/applications /usr/share/applications/inputmethods /usr/share/desktop-directories $0 ${cmd%% *} /etc/xdg/autostart" mm=true a=/dev/null i
case "$cmd" in
*ob3menu*\ --autostart*)a="$HOME/.cache/ya/autostart";;&
*ob3menu*\ --slow)
	c+=" $HOME/.config/ya/rc.xml $HOME/.config/ya/preferred-apps /usr/share/mime/globs /etc/fstab" # /usr/share/icons/*/*/*
	cmd+=" --mime $m.sh $HOME"
;;
*ob3menu*\ --mime\ *)c+=" /usr/share/mime/globs /etc/fstab";;
*mmaker\ *)mm=echo;;
esac
local k="$cmd:$LANG:`stat --printf=%Z $c`" k1
if ! (read k1 <"$m.key" && [ "$k1" = "$k" ]); then
	mkdir -p "${m%/*}"
	{
	$mm '<openbox_pipe_menu>'
	echo $cmd >&2
	$cmd 2>"$a" || echo '' >"$a"
	$mm '</openbox_pipe_menu>'
	} >"$m"
	echo "$k" >"$m.key"
fi
cat "$m" || rm $m.key
}

ob3menu-cache "${@}"
