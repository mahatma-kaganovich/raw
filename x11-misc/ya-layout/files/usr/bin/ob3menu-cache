#!/bin/bash
# pipe menu cache for OpenBox3 v0.7
# icons changes not tracked
# param: generator command:

ob3menu-cache(){
local cmd="${*:-/usr/bin/ob3menu --slow}"
#local cmd="${*:-/usr/bin/mmaker -ci OpenBox3}"
DSP="${DISPLAY//[\\\/*.]/_}"
[ "$DISPLAY" = "$DSP" ] && DSP+='_0'
. "$HOME/.cache/ya/environment.$DSP" && cmd=${cmd/ob3menu --slow/ob3menu --autostart $YA_XDG_AUTOSTART --profile $YA_PROFILE --slow}
local m="$HOME/.cache/ya/menu.xml" c1="/usr/share/applications /usr/share/applications/inputmethods /usr/share/desktop-directories" c="$0 ${cmd%% *} /etc/xdg/autostart" mm=true i m1=return
case "$cmd" in
*ob3menu*\ --autostart*)a="$HOME/.cache/ya/autostart";;&
*ob3menu*\ --launcher*)c+=" $HOME/.config/ya/tint2rc";;&
*ob3menu*\ --slow*)
	c+=" $HOME/.config/ya/rc.xml $HOME/.config/ya/preferred-apps /etc/fstab"
	c1+=" /usr/share/mime/globs" # /usr/share/icons/*/*/*
	cmd+=" --mime $m.sh $HOME"
	m1=
;;
*ob3menu*\ --mime\ *)c+=" /usr/share/mime/globs /etc/fstab";;
*mmaker\ *)mm=echo;;
esac
local k="${cmd%% --init *}:$LANG:`stat --printf=%Z $c $c1 ${c1//\/usr\/share/$HOME/.local}`" k1 mk="$m.${DISPLAY%.*}.key"
if ! (read k1 <"$mk" && [ "$k1" = "$k" ]); then
	mkdir -p "${m%/*}"
	{
	$mm '<openbox_pipe_menu>'
	$cmd || rm "$m"
	$mm '</openbox_pipe_menu>'
	} >"$m"
	echo "$k" >"$mk"
fi
cat "$m" && return
rm "$mk"
$m1
notify-send 'Advanced menu error. Trying simple.'
${cmd%% *}
}

ob3menu-cache "${@}"
