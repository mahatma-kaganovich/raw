#!/bin/bash
# starting minimal openbox+desktop session
# wm is not reloadable
# startup is compromise pure openbox & some accessibility

wm=/usr/bin/openbox
ex=exec
desk=''
pan=''

#if [ ! -e $wm -a -e /usr/bib/xfwm4 ]; then
#	wm=/usr/bin/xfwm4
#	ex=bk
#	desk=/usr/bin/xfdesktop
#	for i in $pan "/usr/bin/xfce4-panel" /usr/bin/lxpanel; do
#		[ -x ${i%% *} ] && pan="$i" && break
#	done
#	pan=xfce4-session
#fi

for i in $desk "/usr/bin/pcmanfm --desktop" /usr/bin/xfdesktop; do
	[ -x ${i%% *} ] && desk="$i" && break
done

bk(){
	shift 2
	$* &
}

envir(){
	for A in "/etc/xdg/$1/environment" "$HOME/.config/$1/environment"; do
		[ -r $A ] && . $A
	done
}

killer(){
	pcmanfm --desktop-off
	xfdesktop --quit
	lxpanelctl exit
	killall -w xfce4-panel xfsettingsd xfce-mcs-manager gnome-settings-daemon
}

runs(){
	for i in "${@}"; do
		[ -n "$i" ] && ($i &) && return 0
	done
	return 1
}

settings(){
	xfsettingsd || (xfce-mcs-manager n &) || (gnome-settings-daemon &) || (/usr/libexec/gnome-settings-daemon &)
}

sess(){
	killer
	$1
	runs "$2" lxpanel
	runs "$3" 'pcmanfm --desktop'
}

while true; do
case "$1" in
--exit) exec $wm --exit ;;
--ce) sess settings xfce4-panel xfdesktop ;;
--lx) sess settings ;;
--0)
	killer
	$desk &
;;
--layout)
	desk(){
		cd "$1" || ( mkdir "$1" && cd "$1" ) || exit 1
	}
	eval "desk ~${2:-$USER}/Desktop"
	for i in /mnt/auto/disk /usr/share/ya-layout/Desktop/*; do
		[ -n "${i##*/.*}" -a -e "$i" -a -e "${i##*/}" ] || ln -s "$i"
	done
	exit
;;
--obsession)
	shift
	envir openbox
	i='/usr/libexec/openbox-autostart OPENBOX'
	[ -z "$desk" ] && desk="$i" || desk="/bin/bash -c '$i;exec $desk'"
	continue
;;
?*)
	echo "Usage: ya-session [command]
Commands: --lx, --ce, --exit, --0, --obsession, --layout [user]"
	exit
;;
*)
	[ -e /usr/bin/dbus-launch ] && eval `/usr/bin/dbus-launch --sh-syntax --exit-with-session`
	xprop -root -remove _NET_NUMBER_OF_DESKTOPS -remove _NET_DESKTOP_NAMES -remove _NET_CURRENT_DESKTOP
	envir ya
	[ -n "$desk" ] && $ex $wm --startup "$desk"
	exec $wm
;;
esac

exec $wm --restart
done
