#!/bin/bash
# starting minimal openbox+desktop session
# wm is not reloadable
# startup is compromise pure openbox & some accessibility

wm=/usr/bin/openbox
Desk=/usr/share/ya-layout/Desktop
obconf="$HOME/.config/ya/rc.xml"
pidfile="$HOME/.cache/ya/running.pids"
sm='--sm-disable'
sm2='--sm-client-disable'

# todo: fill apps list
: ${YA_APP_XF86WWW:="'exo-open --launch WebBrowser' 'seamonkey --browser' firefox chromium midori"}
: ${YA_APP_XF86Mail:="'exo-open --launch MailReader' 'seamonkey --mail' claws-mail thunderbird"}
: ${YA_APP_TerminalEmulator:="'exo-open --launch TerminalEmulator' Terminal lxterminal kterm xterm"}
: ${YA_APP_FileManager:="'exo-open --launch FileManager' pcmanfm Thunar 'nautilus --no-desktop' +mc"}
: ${YA_APP_XF86AudioMedia:="audacious aqualung vlc mplayer"}
: ${YA_APP_XF86VideoMedia:="mplayer2 mplayer vlc"}
: ${YA_APP_XF86Calendar:="orage"}
: ${YA_APP_XF86Calculator="gpe-calculator"}
: ${YA_APP_XF86Messenger="pidgin"}
#
: ${YA_APP_XF86SettingsManager="'xfsettingsd -d' xfce-mcs-manager gnome-settings-daemon /usr/libexec/gnome-settings-daemon"}
: ${YA_APP_XF86Panel="'xfce4-panel $sm2' lxpanel"}
: ${YA_APP_XF86Desktop="'pcmanfm --desktop' 'xfdesktop $sm2' nautilus"}

err(){
	echo "ERROR: ${@}"
	exit 1
}

1of(){
	local i x p
	for i in "${@}"; do
		x=`which "${i%% *}" 2>/dev/null` || continue
		p="${i#* }"
		[ "$p" = "$i" ] && echo "$x" || echo "$x $p"
		return 0
	done
	return 1
}

1cfg(){
	local i
	for i in "$HOME"/.config/$1 /etc/xdg/$1; do
		[ -r "$i" ] && echo "$i" && return 0
	done
	return 1
}

wm(){
	if [ "$1" = --startup -a "$wm" != /usr/bin/openbox ]; then
		shift
		runs "$*"
		wm
	fi
	for i in $pids; do
		[ -d /proc/$i ] && echo $i
	done >$pidfile
	exec $wm $sm --config-file "$obconf" "${@}"
}

envir(){
	local A
	A=`1cfg "$1/environment"` && [ -r "$A" ] && . "$A"
}

obconfig(){
	mkdir -p "${1%/*}"
	sed -e 's:<animateIconify>yes</animateIconify>:<animateIconify>no</animateIconify>:' \
		-e 's:<file>menu.xml</file>:<file>menu.xml</file>\n<showIcons>yes</showIcons>:' \
		-e 's:<name>Clearlooks</name>:<name>Onyx</name>:' \
		-e 's:</keyboard>:\
		<keybind key="Menu"><action name="ShowMenu"><menu>root-menu</menu></action></keybind>\
		<keybind key="C-Menu"><action name="Execute"><command>ya-session --run "+/usr/bin/sudo /usr/bin/mc"</command></action></keybind>\
		<keybind key="Super_L"><action name="Execute"><command>ya-session --run TerminalEmulator</command></action></keybind>\
		<keybind key="Super_R"><action name="Execute"><command>ya-session --run TerminalEmulator</command></action></keybind>\
		<keybind key="C-Super_L"><action name="Execute"><command>ya-session --run "+/usr/bin/sudo -s"</command></action></keybind>\
		<keybind key="C-Super_R"><action name="Execute"><command>ya-session --run "+/usr/bin/sudo -s"</command></action></keybind>\
		<keybind key="XF86Calculator"><action name="Execute"><command>ya-session --run XF86Calculator</command></action></keybind>\
		<keybind key="XF86WWW"><action name="Execute"><command>ya-session --run XF86WWW</command></action></keybind>\
		<keybind key="XF86Mail"><action name="Execute"><command>ya-session --run XF86Mail</command></action></keybind>\
		<keybind key="XF86AudioMedia"><action name="Execute"><command>ya-session --run XF86AudioMedia</command></action></keybind>\
		<keybind key="XF86MyComputer"><action name="Execute"><command>ya-session --run "FileManager $HOME/Desktop"</command></action></keybind>\
		<keybind key="XF86Messenger"><action name="Execute"><command>ya-session --run XF86Messenger</command></action></keybind>\
		<keybind key="XF86Eject"><action name="Execute"><command>"eject /dev/sr0"</command></action></keybind>\
		</keyboard>:' \
			<"$2" >"$1"
}

killer(){
	pcmanfm --desktop-off
	xfdesktop --quit
	lxpanelctl exit
	kill -w $pids
	pids=''
	killall -w xfce4-panel xfsettingsd xfce-mcs-manager gnome-settings-daemon
}

runs(){
	i=`1of "${@}"` || return 1
	$i &
	i=$?
	pids+="$! "
	return $i
}

_app(){
	for i in "${@}"; do
		x="${i%% *}"
		p1="${i#* }"
		[ "$p1" = "$i" ] || p="$p1 $p"
		pref="${x:0:1}"
		x="${x#[+]}"
#		which "$x" >/dev/null 2>&1 || continue
		x=`which "$x" 2>/dev/null` || continue
		a=" $YA_APP "
		a="${a%% $x *}"
		a="${a%% ${x##*/} }"
		a="${#a}"
		[ $a -lt $mina ] || continue
		mina=$a
		min="$x${p:+ $p}"
		minpref=$pref
	done
}

# select one preferred app
# $YA_APP - global preferred list
# $YA_APP_<name> - substitution list for "name"
# +command - in term
app(){
	local i x a min= mina=$((${#YA_APP}+3)) v p p1 pref minpref=
	for i in "${@}"; do
		x="${i%% *}"
		p="${i#* }"
		[ "$p" = "$i" ] && p=''
		v="YA_APP_${x//-_}"
		[ -n "${!v}" ] && x="${!v}"
		eval "_app $x"
	done
	[ -n "$min" ] && case "$minpref" in
	+)app "TerminalEmulator -e $min";;
	*)echo "$min";;
	esac
	return 1
}

settings(){
	xfsettingsd || runs 'xfce-mcs-manager n' gnome-settings-daemon /usr/libexec/gnome-settings-daemon
}

sessn(){
	export XDG_MENU_PREFIX="$1-" DESKTOP_SESSION="ya"
	# SESSION_MANAGER=
}

sess(){
	killer
	$1
	runs "$2" lxpanel
	runs "$3" 'pcmanfm --desktop -p ya'
}

[ -z "$YA_DESKTOP" ] && YA_DESKTOP=`1of $desk '/usr/bin/pcmanfm --desktop -p ya' "/usr/bin/xfdesktop $sm2" /usr/bin/nautilus`
desk="$YA_DESKTOP"
pids=`cat "$pidfile" 2>/dev/null` || {
	mkdir -p "${pidfile%/*}"
	touch "$pidfile" || err "unable to touch '$pidfile'"
}
sessn ya
while true; do
case "$1" in
--exit)exec killall xinit X $wm ;;
--ce)sessn xfce;sess settings "xfce4-panel $sm2" "xfdesktop $sm2" ;;
--lx)sessn lxde;sess settings 'lxpanel -p LXDE' 'pcmanfm --desktop -p LXDE' ;;
--ya)
	sessn ya
	killer
	for i in XF86SettingsManager XF86Panel XF86Desktop; do
		i=`app $i` || continue
		$i &
		pids+="$! "
	done
;;
--0)
	killer
	$desk &
;;
--layout)
	desk(){
		cd "$1" || ( mkdir "$1" && cd "$1" ) || err "in '~/Desktop'"
	}
	eval "desk ~${2:-$USER}/Desktop"
	for i in /mnt/auto/disk $Desk/*; do
		[ -n "${i##*/.*}" -a -e "$i" -a -e "${i##*/}" ] || ln -s "$i"
	done
	exit
;;
--obsession)
	shift
	envir openbox
	i='/usr/libexec/openbox-autostart OPENBOX'
	[ -z "$desk" ] && desk="$i" || desk="/bin/bash -c '$i;exec $desk'"
	continue
;;
--open)
	shift
	desk=`1of '/usr/bin/pcmanfm -p ya' /usr/bin/Thunar '/usr/bin/nautilus --no-desktop' /usr/bin/dolphin '/usr/bin/exo-open --launch FileManager'` && for i in $Desk $HOME/Desktop; do
		[ -d "$i" ] && desk="$desk $i"
	done
	continue
;;
--run)
	shift
	i="$(app "${@}")"
	case "$i" in
	*exo-open\ --launch\ TerminalEmulator\ -e\ *)i="${i/ -e}";;
	esac
	exec $i
;;
--obconfig)
	shift
	obconfig "${@}"
	exit
;;
?*)
	i=" ${!YA_APP_*}"
	i="${i// YA_APP_/,}"
	i="${i#,}"
	echo "Usage: ya-session [command]
Commands: --lx, --ce, --exit, --0, --obsession, --open, --layout [user], --run 'cmd1' ['cmd2'...]
.xinitrc examples:
	minimal: exec ya-session'
	openbox-style: exec ya-session --open --obsession
One-shot desktop update: ya-session --layout
or: ln -s $Desk ~/Desktop/desktop
Launcher: ya-session --run 'cmd1' 'cmd2' ...
	- launch first found command, preferred in \$YA_APP variable
	(prefixed by '+' to terminal)
	and/or substituted via \$YA_APP_<cmd> variables:
	$i"
	exit
;;
*)
	pids=''
	[ -e /etc/udev/rules.d/88-autofs.rules -a ! -e /var/run/auto.dev ] && . /usr/share/ya-layout/autofs-all
	[ -x /usr/bin/dbus-launch ] && eval `/usr/bin/dbus-launch --sh-syntax --exit-with-session`
	xprop -root -remove _NET_NUMBER_OF_DESKTOPS -remove _NET_DESKTOP_NAMES -remove _NET_CURRENT_DESKTOP
	envir ya
	[ -s "$obconf" ] || obconfig "$obconf" $(1cfg openbox/rc.xml)
	xrdb -merge $(1cfg ya/Xresources) </dev/null
	i=`1cfg "ya/wallpaper.*"` && case "$desk" in
	*pcmanfm*)desk+=" -w $i";;
	esac
	export YA_DESKTOP
	wm ${desk:+--startup "$desk"}
;;
esac
wm --restart
done
