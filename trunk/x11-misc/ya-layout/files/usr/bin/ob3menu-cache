#!/bin/bash
# pipe menu cache for OpenBox3 v0.2
# icons changes not tracked
# param: generator command:
cmd="${*:-/usr/bin/ob3menu --slow}"
#cmd="${*:-/usr/bin/mmaker -ci OpenBox3}"

m="$HOME/.cache/ya/menu.xml"
c="/usr/share/applications $0 ${cmd%% *}"
mm='#'
cat=cat
a=/dev/null
auto='#'

key(){
	echo "$cmd
$LANG"
	ls -lsR $c
}

case "$cmd" in
*ob3menu*\ --autostart*)cat='#';auto='.';a="$HOME/.cache/ya/autostart";;&
*ob3menu*\ --slow\ *)c+=" ${3%/*}";;
*mmaker\ *)mm=echo;;
esac
{
if ! (key|cmp -s - "$m.key" && [ -s "$m" ] ); then
	mkdir -p "${m%/*}"
	{
	$mm '<openbox_pipe_menu>'
	$cmd 2>"$a" || echo '' >"$a"
	$mm '</openbox_pipe_menu>'
	} >"$m"
	key >"$m.key"
fi
$cat "$m"
} 2>/dev/null
$auto "$a"
