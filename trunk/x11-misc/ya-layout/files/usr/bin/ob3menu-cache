#!/bin/bash
# pipe menu cache for OpenBox3 v0.2
# icons changes not tracked
# param: generator command:

ob3mkey(){
	echo "$cmd
$LANG"
	ls -lsR $c
}

ob3menu-cache(){
local cmd="${*:-/usr/bin/ob3menu --slow}"
#local cmd="${*:-/usr/bin/mmaker -ci OpenBox3}"
. "$HOME/.cache/env" 2>/dev/null && export YA_PROFILE
cmd=${cmd/ob3menu --slow/ob3menu --autostart $YA_XDG_AUTOSTART --slow}
local m="$HOME/.cache/ya/menu.xml" c="/usr/share/applications /usr/share/desktop-directories $0 ${cmd%% *} /etc/xdg/autostart" mm='#' cat=cat a=/dev/null
case "$cmd" in
*ob3menu*\ --autostart*)a="$HOME/.cache/ya/autostart";;&
*ob3menu*\ --slow\ *)c+=" ${3%/*}";;
*mmaker\ *)mm=echo;;
esac
{
if ! (ob3mkey|cmp -s - "$m.key" && [ -s "$m" ] ); then
	mkdir -p "${m%/*}"
	{
	$mm '<openbox_pipe_menu>'
	$cmd 2>"$a" || echo '' >"$a"
	$mm '</openbox_pipe_menu>'
	} >"$m"
	ob3mkey >"$m.key"
fi
$cat "$m"
} 2>/dev/null
}

ob3menu-cache "${@}"
