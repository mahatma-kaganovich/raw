cgroups for mpm-itk for Apache 2 v0.6

Usage: AssignUserID USER GROUP [/dev/cgroup/CGROUP/tasks]
Too simple: user or group must be changed to change cgroup.

Signed-off-by: Denis Kaganovich <mahatma@eu.by>

--- a/server/mpm/itk/itk.c	2011-12-11 15:14:11.000000000 +0300
+++ a/server/mpm/experimental/itk/itk.c	2011-12-11 15:13:32.000000000 +0300
@@ -18,6 +18,9 @@
  *
  * Portions copyright 2008 Knut Auvor Grythe <knut@auvor.no>.
  * Licensed under the same terms as the rest of Apache.
+ *
+ * Portions copyright 2011 Denis Kaganovich <mahatma@eu.by>.
+ * Licensed under the same terms as the rest of Apache.
  */
 
 #include "apr.h"
@@ -171,6 +174,7 @@ typedef struct
     gid_t gid;
     char *username;
     int nice_value;
+    apr_file_t *pidfile;
 } itk_per_dir_conf;
 
 typedef struct
@@ -1578,6 +1582,10 @@ static int itk_post_perdir_config(reques
     }
 
     if (!err && wanted_uid != -1 && wanted_gid != -1 && (getuid() != wanted_uid || getgid() != wanted_gid)) {
+        if (dconf->pidfile && !apr_file_printf(dconf->pidfile, "%d\n", getpid())) {
+            _DBG("apr_file_printf(): %s", strerror(errno));
+            err = 1;
+        } else
         if (setgid(wanted_gid)) {
             _DBG("setgid(%d): %s", wanted_gid, strerror(errno));
             err = 1;
@@ -1685,12 +1696,19 @@ static const char *set_server_limit (cmd
     return NULL;
 }
 
-static const char *assign_user_id (cmd_parms *cmd, void *ptr, const char *user_name, const char *group_name)
+static const char *assign_user_id (cmd_parms *cmd, void *ptr, const char *user_name, const char *group_name, const char *pid_file)
 {
     itk_per_dir_conf *dconf = (itk_per_dir_conf *) ptr;
     dconf->username = apr_pstrdup(cmd->pool, user_name);
     dconf->uid = ap_uname2id(user_name);
     dconf->gid = ap_gname2id(group_name);
+    if (pid_file) {
+       if (apr_file_open(&dconf->pidfile, pid_file, APR_WRITE | APR_APPEND, APR_OS_DEFAULT, cmd->pool) != APR_SUCCESS) {
+          _DBG("apr_file_open(%s): %s", pid_file, strerror(errno));
+          return "Unable to open cgroup/pidfile";
+       }
+    } else
+        dconf->pidfile = NULL;
     return NULL;
 }
 
@@ -1740,1 +1759,1 @@
-AP_INIT_TAKE2("AssignUserID", assign_user_id, NULL, RSRC_CONF|ACCESS_CONF,
+AP_INIT_TAKE23("AssignUserID", assign_user_id, NULL, RSRC_CONF|ACCESS_CONF,
@@ -1754,6 +1773,7 @@ static void *itk_create_dir_config(apr_p
         apr_pcalloc(p, sizeof(itk_per_dir_conf));
     c->uid = c->gid = -1;
     c->nice_value = UNSET_NICE_VALUE;
+    c->pidfile = NULL;
     return c;
 }
 
@@ -1769,10 +1789,12 @@ static void *itk_merge_dir_config(apr_po
       c->username = child->username;
       c->uid = child->uid;
       c->gid = child->gid;
+      c->pidfile = child->pidfile;
     } else {
       c->username = parent->username;
       c->uid = parent->uid;
       c->gid = parent->gid;
+      c->pidfile = parent->pidfile;
     }
     if (child->nice_value != UNSET_NICE_VALUE) {
       c->nice_value = child->nice_value;
