#!/bin/sh

fs='ext4:-q:-O:sparse_super2:-O:^has_journal:-O:inline_data:-O:dir_index:-O:extent:-E:discard:-E:num_backup_sb=0'
kv=`uname -r`
[ "${kv%%.*}" -lt 4 ] && fs='ext4:-E:discard'

help="

mount.zram v0.7 (c) mahatma, under Anarchy license
Mount helper to mount zram (or ram/brd) devices via /etc/fstab over most simple way, stupid.
Usage:	mount -t zram ...
	mount.zram /dev/zram<X> <mountpoint> -o <options>
	mount.zram /dev/ram<X> <mountpoint> -o <options>
	mount.zram /dev/ram0 <mountpoint> -o disksize=<N>,<options>
Loading zram module with number of devices just from FIRST mount device in fstab.
(so, first device is highest number)
Loading brd module for /dev/ram0 ONLY.
Mount options:
	'fs=<fs[{:mkfs_options}]> (default fs=$fs),
	<zram_param>=<value> where <zram_param> is any file from /sys/block/zramX/
	zramctl:<options> - alternative to sysfs - use zramctl tool (spaces replaced to ':')
	disksize=<N> - for /dev/ram0 - compatible with zram, bound single brd/ram disk to N.
	other options pass directly to <fs> mount.
	First trying to mount with '-o discard...'.
Examples of /etc/fstab:
	/dev/zram3 /tmp zram disksize=8g 0 0
	/dev/zram1 /tmp zram comp_algorithm=lz4,disksize=8g,lazytime,noatime,dioread_nolock 0 0
	/dev/zram0 /var/tmp/portage zram reset=1,comp_algorithm=lz4,disksize=12g,lazytime,sync,noatime,dioread_nolock 0 0
	/dev/ram0 /var/cache/fscache zram disksize=1g,lazytime,dax,dioread_nolock,nobarrier,inode_readahead_blks=0,nodelalloc 0 0
    Over zramctl:
	/dev/zram3 /tmp zram zramctl:-alz4:-s8g 0 0
	/dev/zram3 /tmp zram zramctl:--algorithm=lz4:--size=8g 0 0
"

err(){
	echo "
ERROR $0: $1" >&2
	exit ${2:-1}
}

warn(){
	echo "WARNING $0: ignored failed: $1" >&2
}

size2b(){
	local v="$1" x
	x="${v%?}"
	case "$v" in
	*k|*K)v="$x";;
	*m|*M)v=$((x*1024));;
	*g|*G)v=$((x*1024*1024));;
	*t|*T)v=$((x*1024*1024*1024));;
	esac
	echo "$v"
}

disksize=
n="${1##*/}"
i="/sys/block/$n"
c="$i"
case "$1" in
/dev/*/*)err "$*$help";;
/dev/zram*)
	nn=${1#/dev/zram}
	[ -e /sys/module/zram -o -e /dev/zram0 ] || modprobe zram num_devices=$((nn+1))
	[ -e "$i" ] || sleep 1
	c="$i/comp_algorithm"
;;
/dev/ram0)
	for j in ${4//,/ }; do
		v="${j#disksize=}"
		[ "$v" = "$j" ] || disksize="$(size2b "$v")"
	done
	[ -n "$disksize" ] && modprobe brd rd_nr=1 rd_size="$disksize" max_part=0
;;&
/dev/ram*)
	[ -e "$i" ] || sleep 1
	c="$i/size"
;;
*)err "$*$help";;
esac
[ -z "$c" -o -e "$c" ] || err "no $c"
echo 0 >"$i/queue/rotational"
o=
ig=
re=",$4,"
ig(){
	[ -z "${re##*,remount,*}" ] || err "$1"
	ig="$ig,$i"
}
for i in ${4//,/ }; do
	v="${i#*=}"
	[ "$v" = "$i" ] || {
		x="${i%%=*}"
		case "$x" in
		disksize)[ -n "$disksize" ] && continue;; # /dev/ram0
		zramctl:*) # unify mkfs here?
			c="${i//:/ } $1"
			$c || ig "$c"
			continue
		;;
		fs|mode|uid|gid)eval "$x=\"\$v\"";;&
		fs)continue;;
		esac
		f="/sys/block/$n/$x"
		[ -e "$f" ] && {
			#[ -n "${re##*,remount,*}" ] && continue
			echo "$v" >"$f" 2>/dev/null && continue
			v1="$(cat "$f")" && [ -n "$v1" ] && ( [ "$v1" = "$v" ] || [ "$v1" = "$(size2b "$v")" ] || [ -z "${v1##*\[$v\]*}" ] ) && continue
			ig "echo $v >$f"
			continue
		}
	}
	o="$o,$i"
done
[ -b "$1" ] || err " -b $1$help"
o="${o#,}"

fs="${fs//:/ }"
mkfs="mkfs.$fs $1"
fs="${fs%% *}"

[ -z "${re##*,remount,*}" ] || yes '' | $mkfs || warn "$mkfs"

# move original mountpoint permissions to mount if not fs-assisted
[ -z "$mode" ] && m=`stat "$2" --format='%a'`
[ -z "$uid$gid" ] && ug=`stat "$2" --format='%u:%g'` || ug=

for i in discard"${o+,$o}" "$o"; do
	mount -t "$fs" ${i+-o $i} "$1" "$2" && {
		[ -n "$m" ] && chmod -- "$m" "$2"
		[ -n "$ug" ] && chown -- "$ug" "$2"
		[ -n "$ig" ] && warn "options '${ig#,}'"
		exit 0
	}
	r=$?
done
err "mount -t $fs ${o+-o $o} $1 $2" $r
