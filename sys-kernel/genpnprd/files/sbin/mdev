#!/bin/sh
# some of busyboxes don't have mdev, some - mdev.conf|/dev/input/

mdevs(){
	for i in $*; do
		local DEVNAME="" MAJOR="" MINOR="" FIRMWARE="" DEVPATH="" DEVMODE=""
		eval "$(sed -e 's:^\(.*\)=\([^"].*[^"]\)$:\1="\2":g' -e 's/^[^=]*$//g' <"$i")" || echo "== $i"
		i="${i#/sys/class/}"
		mdev "${i%%/*}"
	done
}

mdev(){
local i t=c
case "$1" in
block) t=b ;;
-s)
	shift
	for i in ${*:-"*"}; do
		mdevs /sys/class/$i/*/uevent
	done
	return
;;
esac
case "$ACTION" in
remove)
	rm "/dev/$DEVNAME"
	return
;;
add)
	[[ -n "$MODALIAS" ]] && echo "$MODALIAS" >>/etc/modalias
;;
esac
if [[ -n "$DEVNAME" ]] && ! [[ -e "/dev/$DEVNAME" ]]; then
	DEVNAME="/dev/$DEVNAME"
	i="${DEVNAME%/*}"
	[[ -e "$i" ]] || mkdir -p "$i"
	mknod -m ${DEVMODE:-0600} "$DEVNAME" $t $MAJOR $MINOR
fi
[[ -z "$FIRMWARE" ]] && return
echo 1 >/sys/$DEVPATH/loading
[[ -e /lib/firmware/$FIRMWARE ]] && cat /lib/firmware/$FIRMWARE >/sys/$DEVPATH/data && echo 0 >/sys/$DEVPATH/loading && return
echo -1 >/sys/$DEVPATH/loading
}

mdev $*
