--- samba-4.4.2.ebuild	2016-04-29 19:51:58.000000000 +0300
+++ samba-4.4.3.ebuild	2016-05-02 22:51:58.000000000 +0300
@@ -1,6 +1,6 @@
-# Copyright 1999-2015 Gentoo Foundation
+# Copyright 1999-2016 Gentoo Foundation
 # Distributed under the terms of the GNU General Public License v2
-# $Header: /var/cvsroot/gentoo-x86/net-fs/samba/samba-4.2.0.ebuild,v 1.1 2015/03/08 13:21:55 polynomial-c Exp $
+# $Id$
 
 EAPI=6
 PYTHON_COMPAT=( python2_7 )
@@ -16,8 +16,8 @@
 
 SRC_URI="mirror://samba/${SRC_PATH}/${MY_P}.tar.gz
 	https://dev.gentoo.org/~axs/distfiles/samba-disable-python-patches-4.4.2.tar.xz"
+[[ ${PV} = *_rc* ]] || \
 KEYWORDS="~amd64 ~hppa ~x86"
-[[ ${PV} = *_rc* ]] && KEYWORDS="~hppa"
 
 DESCRIPTION="Samba Suite Version 4"
 HOMEPAGE="http://www.samba.org/"
@@ -26,15 +26,19 @@
 SLOT="0"
 
 IUSE="acl addc addns ads avahi client cluster cups dmapi fam gnutls iprint
-ldap pam quota selinux syslog systemd test winbind afs sasl"
+ldap pam quota selinux syslog +system-mitkrb5 systemd test winbind"
 
 MULTILIB_WRAPPED_HEADERS=(
 	/usr/include/samba-4.0/policy.h
 	/usr/include/samba-4.0/dcerpc_server.h
+	/usr/include/samba-4.0/ctdb.h
+	/usr/include/samba-4.0/ctdb_client.h
+	/usr/include/samba-4.0/ctdb_protocol.h
+	/usr/include/samba-4.0/ctdb_private.h
+	/usr/include/samba-4.0/ctdb_typesafe_cb.h
+	/usr/include/samba-4.0/ctdb_version.h
 )
 
-# useflag sasl control only cyrus-sasl linking, not own sasl wrapper
-
 # sys-apps/attr is an automagic dependency (see bug #489748)
 CDEPEND="${PYTHON_DEPS}
 	>=app-arch/libarchive-3.1.2[${MULTILIB_USEDEP}]
@@ -52,7 +56,7 @@
 	>=sys-libs/tdb-1.3.8[python,${PYTHON_USEDEP},${MULTILIB_USEDEP}]
 	>=sys-libs/tevent-0.9.28[${MULTILIB_USEDEP}]
 	sys-libs/zlib[${MULTILIB_USEDEP}]
-	pam? ( virtual/pam )
+	virtual/pam
 	acl? ( virtual/acl )
 	addns? ( net-dns/bind-tools[gssapi] )
 	cluster? ( !dev-db/ctdb )
@@ -62,12 +66,8 @@
 	gnutls? ( dev-libs/libgcrypt:0
 		>=net-libs/gnutls-1.4.0 )
 	ldap? ( net-nds/openldap[${MULTILIB_USEDEP}] )
-	afs? ( net-fs/openafs )
-	sasl? ( dev-libs/cyrus-sasl )
-	|| (
-		app-crypt/mit-krb5[${MULTILIB_USEDEP}]
-		>=app-crypt/heimdal-1.5[-ssl,${MULTILIB_USEDEP}]
-	)
+	system-mitkrb5? ( app-crypt/mit-krb5[${MULTILIB_USEDEP}] )
+	!system-mitkrb5? ( >=app-crypt/heimdal-1.5[-ssl,${MULTILIB_USEDEP}] )
 	systemd? ( sys-apps/systemd:0= )"
 DEPEND="${CDEPEND}
 	virtual/pkgconfig"
@@ -76,20 +76,23 @@
 	selinux? ( sec-policy/selinux-samba )
 "
 
-REQUIRED_USE="addc? ( gnutls )
+REQUIRED_USE="addc? ( gnutls !system-mitkrb5 )
 	ads? ( acl gnutls ldap )
 	${PYTHON_REQUIRED_USE}"
 
 S="${WORKDIR}/${MY_P}"
 
 PATCHES=(
-	"${FILESDIR}/${PN}-4.2.3-ctdb.patch"
-	)
+	"${FILESDIR}/${PN}-4.2.3-heimdal_compilefix.patch"
+	"${FILESDIR}/${PN}-4.4.0-pam.patch"
+)
 
 CONFDIR="${FILESDIR}/$(get_version_component_range 1-2)"
 
 WAF_BINARY="${S}/buildtools/bin/waf"
 
+SHAREDMODS=""
+
 pkg_setup() {
 	python-single-r1_pkg_setup
 	if use cluster ; then
@@ -100,28 +103,12 @@
 src_prepare() {
 	default
 
-#	has_version app-crypt/heimdal && sed -i -e 's:USING_SYSTEM_KDC:USING_SYSTEM_KDC_:' source4/kdc/wscript_build
-	use sasl || sed -i -e 's:HAVE_SASL:HAVE_SASL_:' source4/auth/wscript_configure
-	sed -i -e 's:/tmp/ctdb.socket:/var/run/ctdb/ctdb.socket:g' {ctdb/doc,docs-xml/smbdotconf/misc}/*ml
-
 	# install the patches from tarball(s)
 	eapply "${WORKDIR}/patches/"
 
-	# samba-4.2.3-heimdal_compilefix.patch
-	sed -i -e 's:tgs_use_strongest_session_key:svc_use_strongest_session_key:' -e 's:as_use_strongest_session_key:tgt_use_strongest_session_key:' source4/kdc/kdc.c
-	has_version '<app-crypt/heimdal-1.6.99' && sed -i -e 's:HDB_ERR_WRONG_REALM:HDB_ERR_NOENTRY:' source4/kdc/db-glue.c
-
 	multilib_copy_sources
 }
 
-automagic(){
-	local i
-	for i in "${@}"; do
-		egrep "#define.*$i.*" "${S}"/bin/default/include/config.h
-		sed -i -e "/#define.*$i.*/d" "${S}"/bin/default/include/config.h
-	done
-}
-
 multilib_src_configure() {
 	local myconf=()
 	myconf=(
@@ -129,7 +116,7 @@
 		--sysconfdir=/etc
 		--localstatedir=/var
 		--with-modulesdir=/usr/$(get_libdir)/samba
-		--with-piddir=/var/run/${PN}
+		--with-piddir=/run/${PN}
 		--bundled-libraries=NONE
 		--builtin-libraries=NONE
 		--disable-rpath
@@ -138,7 +125,6 @@
 		--nopyo
 	)
 	if multilib_is_native_abi ; then
-
 		myconf+=(
 			$(use_with acl acl-support)
 			$(usex addc '' '--without-ad-dc')
@@ -158,12 +144,11 @@
 			$(use_with quota quotas)
 			$(use_with syslog)
 			$(use_with systemd)
-			$(use_with afs fake-kaserver)
-			$(has_version app-crypt/mit-krb5 && echo --with-system-mitkrb5)
+			$(usex system-mitkrb5 '--with-system-mitkrb5' '')
 			$(use_with winbind)
 			$(usex test '--enable-selftest' '')
 			--with-shared-modules=${SHAREDMODS}
-		)  #'"
+		)
 	else
 		myconf+=(
 			--without-acl-support
@@ -171,7 +156,7 @@
 			--without-dnsupdate
 			--without-ads
 			--disable-avahi
-			$(use_with cluster cluster-support)
+			--without-cluster-support
 			--disable-cups
 			--without-dmapi
 			--without-fam
@@ -182,19 +167,14 @@
 			--without-quotas
 			--without-syslog
 			--without-systemd
-			$(has_version app-crypt/mit-krb5 && echo --with-system-mitkrb5)
+			$(usex system-mitkrb5 '--with-system-mitkrb5' '')
 			--without-winbind
 			--disable-python
 		)
 	fi
+
 	CPPFLAGS="-I${SYSROOT}/usr/include/et ${CPPFLAGS}" \
 		waf-utils_src_configure ${myconf[@]}
-
-	einfo "Removing automagic definitions"
-	# KDC wrong here
-	use pam || automagic _PAM_ '_LIBPAM '
-	use sasl || automagic SASL
-
 }
 
 multilib_src_install() {
@@ -210,6 +190,11 @@
 			doins examples/LDAP/samba.schema
 		fi
 
+		# create symlink for cups (bug #552310)
+		if use cups ; then
+			dosym /usr/bin/smbspool /usr/libexec/cups/backend/smb
+		fi
+
 		# install example config file
 		insinto /etc/samba
 		doins examples/smb.conf.default
@@ -218,13 +203,6 @@
 		newinitd "${CONFDIR}/samba4.initd-r1" samba
 		newconfd "${CONFDIR}/samba4.confd" samba
 
-		if use cluster; then
-			newinitd "${CONFDIR}/ctdb.initd" ctdb
-			newconfd "${CONFDIR}/ctdb.confd" ctdb
-			exeinto /etc/ctdb/notify.d
-			doexe "${CONFDIR}/10.samba"
-		fi
-
 		systemd_dotmpfilesd "${FILESDIR}"/samba.conf
 		systemd_dounit "${FILESDIR}"/nmbd.service
 		systemd_dounit "${FILESDIR}"/smbd.{service,socket}
